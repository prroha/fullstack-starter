// Prisma Schema - Starter Template
// Customize this schema for your application

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  USER
  ADMIN
}

enum ContactMessageStatus {
  PENDING
  READ
  REPLIED
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  SYSTEM
}

// ============================================================================
// MODELS
// ============================================================================

/// User model - core authentication
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String?
  avatarUrl     String?   @map("avatar_url")
  role          UserRole  @default(USER)
  isActive      Boolean   @default(true) @map("is_active")
  emailVerified Boolean   @default(false) @map("email_verified")

  // OAuth support (optional)
  googleId      String?   @unique @map("google_id")
  authProvider  String    @default("email") @map("auth_provider")

  // Session management
  activeDeviceId String?  @map("active_device_id")

  // Account lockout (brute force protection)
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")
  lastFailedLogin     DateTime? @map("last_failed_login")

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  passwordResetTokens PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  sessions    Session[]
  auditLogs   AuditLog[]
  notifications Notification[]
  // posts        Post[]
  // comments     Comment[]

  @@index([email])
  @@index([googleId])
  @@map("users")
}

// ============================================================================
// PASSWORD RESET
// ============================================================================

/// Password reset token for forgot password flow
model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

// ============================================================================
// EMAIL VERIFICATION
// ============================================================================

/// Email verification token for verifying user email addresses
model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("email_verification_tokens")
}

// ============================================================================
// SESSION MANAGEMENT
// ============================================================================

/// Session model for managing user login sessions across devices
model Session {
  id                String   @id @default(uuid())
  visibleId         String   @unique @default(uuid()) @map("visible_id")
  userId            String   @map("user_id")
  refreshTokenHash  String   @map("refresh_token_hash")
  ipAddress         String?  @map("ip_address")
  userAgent         String?  @map("user_agent")
  deviceName        String?  @map("device_name")
  browser           String?
  os                String?
  lastActiveAt      DateTime @default(now()) @map("last_active_at")
  createdAt         DateTime @default(now()) @map("created_at")
  expiresAt         DateTime @map("expires_at")

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshTokenHash])
  @@index([expiresAt])
  @@map("sessions")
}

// ============================================================================
// CONTACT MESSAGES
// ============================================================================

/// Contact form messages from public visitors
model ContactMessage {
  id        String               @id @default(uuid())
  name      String
  email     String
  subject   String
  message   String               @db.Text
  status    ContactMessageStatus @default(PENDING)
  createdAt DateTime             @default(now()) @map("created_at")
  updatedAt DateTime             @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdAt])
  @@map("contact_messages")
}

// ============================================================================
// AUDIT LOG
// ============================================================================

/// Audit log action types
enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGE
  PASSWORD_RESET
  EMAIL_VERIFY
  ADMIN_ACTION
}

/// Audit log for tracking user actions
model AuditLog {
  id        String      @id @default(uuid())
  userId    String?     @map("user_id")
  action    AuditAction
  entity    String      // e.g., "User", "Profile", "Session"
  entityId  String?     @map("entity_id")
  changes   Json?       // JSON object with old/new values (sensitive data excluded)
  ipAddress String?     @map("ip_address")
  userAgent String?     @map("user_agent")
  metadata  Json?       // Additional context data
  createdAt DateTime    @default(now()) @map("created_at")

  user      User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

/// In-app notifications for users
model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType @default(INFO)
  title     String
  message   String
  data      Json?            // Optional JSON data for action links, metadata, etc.
  read      Boolean          @default(false)
  createdAt DateTime         @default(now()) @map("created_at")

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================================
// EXAMPLE: Add your own models below
// ============================================================================

/// Example Post model - remove or customize
// model Post {
//   id          String   @id @default(uuid())
//   title       String
//   content     String?
//   published   Boolean  @default(false)
//   authorId    String   @map("author_id")
//   author      User     @relation(fields: [authorId], references: [id])
//   createdAt   DateTime @default(now()) @map("created_at")
//   updatedAt   DateTime @updatedAt @map("updated_at")
//
//   @@index([authorId])
//   @@map("posts")
// }
