// Prisma Schema - Starter Template
// Customize this schema for your application

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum ContactMessageStatus {
  PENDING
  READ
  REPLIED
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  SYSTEM
}

// ============================================================================
// MODELS
// ============================================================================

/// User model - core authentication
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String?
  avatarUrl     String?   @map("avatar_url")
  role          UserRole  @default(USER)
  isActive      Boolean   @default(true) @map("is_active")
  emailVerified Boolean   @default(false) @map("email_verified")

  // OAuth support (optional)
  googleId      String?   @unique @map("google_id")
  authProvider  String    @default("email") @map("auth_provider")

  // Session management
  activeDeviceId String?  @map("active_device_id")

  // Account lockout (brute force protection)
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")
  lastFailedLogin     DateTime? @map("last_failed_login")

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  passwordResetTokens PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  sessions    Session[]
  auditLogs   AuditLog[]
  notifications Notification[]
  orders      Order[]
  // posts        Post[]
  // comments     Comment[]

  @@index([email])
  @@index([googleId])
  @@map("users")
}

// ============================================================================
// PASSWORD RESET
// ============================================================================

/// Password reset token for forgot password flow
model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

// ============================================================================
// EMAIL VERIFICATION
// ============================================================================

/// Email verification token for verifying user email addresses
model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("email_verification_tokens")
}

// ============================================================================
// SESSION MANAGEMENT
// ============================================================================

/// Session model for managing user login sessions across devices
model Session {
  id                String   @id @default(uuid())
  visibleId         String   @unique @default(uuid()) @map("visible_id")
  userId            String   @map("user_id")
  refreshTokenHash  String   @map("refresh_token_hash")
  ipAddress         String?  @map("ip_address")
  userAgent         String?  @map("user_agent")
  deviceName        String?  @map("device_name")
  browser           String?
  os                String?
  lastActiveAt      DateTime @default(now()) @map("last_active_at")
  createdAt         DateTime @default(now()) @map("created_at")
  expiresAt         DateTime @map("expires_at")

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshTokenHash])
  @@index([expiresAt])
  @@map("sessions")
}

// ============================================================================
// CONTACT MESSAGES
// ============================================================================

/// Contact form messages from public visitors
model ContactMessage {
  id        String               @id @default(uuid())
  name      String
  email     String
  subject   String
  message   String               @db.Text
  status    ContactMessageStatus @default(PENDING)
  createdAt DateTime             @default(now()) @map("created_at")
  updatedAt DateTime             @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdAt])
  @@map("contact_messages")
}

// ============================================================================
// AUDIT LOG
// ============================================================================

/// Audit log action types
enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGE
  PASSWORD_RESET
  EMAIL_VERIFY
  ADMIN_ACTION
}

/// Audit log for tracking user actions
model AuditLog {
  id        String      @id @default(uuid())
  userId    String?     @map("user_id")
  action    AuditAction
  entity    String      // e.g., "User", "Profile", "Session"
  entityId  String?     @map("entity_id")
  changes   Json?       // JSON object with old/new values (sensitive data excluded)
  ipAddress String?     @map("ip_address")
  userAgent String?     @map("user_agent")
  metadata  Json?       // Additional context data
  createdAt DateTime    @default(now()) @map("created_at")

  user      User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// NOTIFICATIONS
// ============================================================================

/// In-app notifications for users
model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType @default(INFO)
  title     String
  message   String
  data      Json?            // Optional JSON data for action links, metadata, etc.
  read      Boolean          @default(false)
  createdAt DateTime         @default(now()) @map("created_at")

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================================
// FAQ
// ============================================================================

/// FAQ category for organizing questions
model FaqCategory {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  order     Int      @default(0)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  faqs      Faq[]

  @@index([slug])
  @@index([isActive])
  @@map("faq_categories")
}

/// Frequently asked questions
model Faq {
  id         String       @id @default(uuid())
  categoryId String?      @map("category_id")
  question   String
  answer     String       @db.Text
  order      Int          @default(0)
  isActive   Boolean      @default(true) @map("is_active")
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  category   FaqCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([categoryId])
  @@index([isActive])
  @@index([order])
  @@map("faqs")
}

// ============================================================================
// ANNOUNCEMENTS
// ============================================================================

enum AnnouncementType {
  INFO
  WARNING
  SUCCESS
  PROMO
}

/// System announcements and banners
model Announcement {
  id        String           @id @default(uuid())
  title     String
  content   String           @db.Text
  type      AnnouncementType @default(INFO)
  startDate DateTime?        @map("start_date")
  endDate   DateTime?        @map("end_date")
  isActive  Boolean          @default(true) @map("is_active")
  isPinned  Boolean          @default(false) @map("is_pinned")
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
  @@map("announcements")
}

// ============================================================================
// SETTINGS
// ============================================================================

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

/// Application settings (key-value store)
model Setting {
  id          String      @id @default(uuid())
  key         String      @unique
  value       String      @db.Text
  type        SettingType @default(STRING)
  description String?
  isPublic    Boolean     @default(false) @map("is_public")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  @@index([key])
  @@index([isPublic])
  @@map("settings")
}

// ============================================================================
// CMS / CONTENT PAGES
// ============================================================================

/// Static content pages managed via CMS
model ContentPage {
  id          String   @id @default(uuid())
  slug        String   @unique
  title       String
  content     String   @db.Text
  metaTitle   String?  @map("meta_title")
  metaDesc    String?  @map("meta_description")
  isPublished Boolean  @default(false) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([slug])
  @@index([isPublished])
  @@map("content_pages")
}

// ============================================================================
// COUPONS
// ============================================================================

enum DiscountType {
  PERCENTAGE
  FIXED
}

/// Coupon model for discount codes
model Coupon {
  id            String       @id @default(uuid())
  code          String       @unique
  discountType  DiscountType @map("discount_type")
  discountValue Float        @map("discount_value")
  minPurchase   Float?       @map("min_purchase")
  maxUses       Int?         @map("max_uses")
  usedCount     Int          @default(0) @map("used_count")
  validFrom     DateTime?    @map("valid_from")
  validUntil    DateTime?    @map("valid_until")
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  @@index([code])
  @@index([isActive])
  @@map("coupons")
}

// ============================================================================
// ORDERS & REVENUE
// ============================================================================

enum OrderStatus {
  PENDING
  COMPLETED
  REFUNDED
  FAILED
}

enum PaymentMethod {
  STRIPE
  PAYPAL
  MANUAL
}

/// Order model for tracking purchases and revenue
model Order {
  id              String        @id @default(uuid())
  userId          String?       @map("user_id")
  email           String
  status          OrderStatus   @default(PENDING)
  paymentMethod   PaymentMethod @default(STRIPE) @map("payment_method")
  paymentId       String?       @map("payment_id")
  subtotal        Float
  discount        Float         @default(0)
  total           Float
  couponCode      String?       @map("coupon_code")
  items           Json          // Array of {productId, productName, price, quantity}
  metadata        Json?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  user            User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}
