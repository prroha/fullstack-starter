// =============================================================================
// Helpdesk Module - Prisma Schema
// =============================================================================
// Standalone schema for the schema merger. No datasource/generator blocks.
// Models reference User by foreign key (userId).

// -----------------------------------------------------------------------------
// Enums
// -----------------------------------------------------------------------------

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_CUSTOMER
  WAITING_ON_AGENT
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AgentRole {
  AGENT
  SUPERVISOR
  ADMIN
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// -----------------------------------------------------------------------------
// Category
// -----------------------------------------------------------------------------

model HelpdeskCategory {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  description String?
  color       String?
  parentId    String?  @map("parent_id")
  isActive    Boolean  @default(true) @map("is_active")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  parent          HelpdeskCategory?  @relation("CategoryParent", fields: [parentId], references: [id], onDelete: SetNull)
  children        HelpdeskCategory[] @relation("CategoryParent")
  tickets         Ticket[]
  articles        KnowledgeBaseArticle[]
  cannedResponses CannedResponse[]

  @@index([userId])
  @@index([parentId])
  @@map("helpdesk_categories")
}

// -----------------------------------------------------------------------------
// Agent
// -----------------------------------------------------------------------------

model HelpdeskAgent {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  name           String
  email          String
  role           AgentRole @default(AGENT)
  department     String?
  isActive       Boolean   @default(true) @map("is_active")
  maxOpenTickets Int       @default(25) @map("max_open_tickets")
  specialties    String[]  @default([])
  lastActiveAt   DateTime? @map("last_active_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  assignedTickets Ticket[] @relation("assignedTickets")
  cannedResponses CannedResponse[]

  @@index([userId])
  @@index([email])
  @@map("helpdesk_agents")
}

// -----------------------------------------------------------------------------
// SLA Policy
// -----------------------------------------------------------------------------

model SlaPolicy {
  id                   String         @id @default(uuid())
  userId               String         @map("user_id")
  name                 String
  description          String?
  priority             TicketPriority
  firstResponseMinutes Int            @map("first_response_minutes")
  resolutionMinutes    Int            @map("resolution_minutes")
  businessHoursOnly    Boolean        @default(false) @map("business_hours_only")
  escalationEmail      String?        @map("escalation_email")
  isActive             Boolean        @default(true) @map("is_active")
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")

  @@index([userId])
  @@index([priority])
  @@map("helpdesk_sla_policies")
}

// -----------------------------------------------------------------------------
// Ticket
// -----------------------------------------------------------------------------

model Ticket {
  id              String         @id @default(uuid())
  userId          String         @map("user_id")
  ticketNumber    String         @unique @map("ticket_number")
  categoryId      String?        @map("category_id")
  assignedAgentId String?        @map("assigned_agent_id")
  subject         String
  description     String
  status          TicketStatus   @default(OPEN)
  priority        TicketPriority @default(MEDIUM)
  slaBreached     Boolean        @default(false) @map("sla_breached")
  firstResponseAt DateTime?      @map("first_response_at")
  resolvedAt      DateTime?      @map("resolved_at")
  closedAt        DateTime?      @map("closed_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  category      HelpdeskCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  assignedAgent HelpdeskAgent?    @relation("assignedTickets", fields: [assignedAgentId], references: [id], onDelete: SetNull)
  messages      TicketMessage[]
  tags          TicketTagLink[]

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([categoryId])
  @@index([assignedAgentId])
  @@map("helpdesk_tickets")
}

// -----------------------------------------------------------------------------
// Ticket Message
// -----------------------------------------------------------------------------

model TicketMessage {
  id         String   @id @default(uuid())
  ticketId   String   @map("ticket_id")
  senderId   String   @map("sender_id")
  senderType String   @map("sender_type") // "customer" | "agent"
  body       String
  isInternal Boolean  @default(false) @map("is_internal")
  createdAt  DateTime @default(now()) @map("created_at")

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("helpdesk_ticket_messages")
}

// -----------------------------------------------------------------------------
// Tag
// -----------------------------------------------------------------------------

model TicketTag {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  name      String
  color     String   @default("#6B7280")
  createdAt DateTime @default(now()) @map("created_at")

  tickets TicketTagLink[]

  @@index([userId])
  @@map("helpdesk_tags")
}

// -----------------------------------------------------------------------------
// Ticket-Tag Link (M2M)
// -----------------------------------------------------------------------------

model TicketTagLink {
  id       String @id @default(uuid())
  ticketId String @map("ticket_id")
  tagId    String @map("tag_id")

  ticket Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  tag    TicketTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([ticketId, tagId])
  @@map("helpdesk_ticket_tags")
}

// -----------------------------------------------------------------------------
// Knowledge Base Article
// -----------------------------------------------------------------------------

model KnowledgeBaseArticle {
  id              String        @id @default(uuid())
  userId          String        @map("user_id")
  categoryId      String?       @map("category_id")
  title           String
  slug            String        @unique
  content         String
  excerpt         String?
  status          ArticleStatus @default(DRAFT)
  tags            String[]      @default([])
  metaTitle       String?       @map("meta_title")
  metaDescription String?       @map("meta_description")
  viewCount       Int           @default(0) @map("view_count")
  helpfulCount    Int           @default(0) @map("helpful_count")
  notHelpfulCount Int           @default(0) @map("not_helpful_count")
  publishedAt     DateTime?     @map("published_at")
  archivedAt      DateTime?     @map("archived_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  category HelpdeskCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([categoryId])
  @@index([status])
  @@map("helpdesk_articles")
}

// -----------------------------------------------------------------------------
// Canned Response
// -----------------------------------------------------------------------------

model CannedResponse {
  id               String    @id @default(uuid())
  userId           String    @map("user_id")
  title            String
  content          String
  shortcut         String?
  categoryId       String?   @map("category_id")
  isShared         Boolean   @default(true) @map("is_shared")
  createdByAgentId String?   @map("created_by_agent_id")
  usageCount       Int       @default(0) @map("usage_count")
  lastUsedAt       DateTime? @map("last_used_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  category       HelpdeskCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  createdByAgent HelpdeskAgent?    @relation(fields: [createdByAgentId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdByAgentId])
  @@map("helpdesk_canned_responses")
}

// -----------------------------------------------------------------------------
// Helpdesk Settings (per-user config)
// -----------------------------------------------------------------------------

model HelpdeskSettings {
  id               String   @id @default(uuid())
  userId           String   @unique @map("user_id")
  companyName      String?  @map("company_name")
  supportEmail     String?  @map("support_email")
  ticketPrefix     String   @default("TKT") @map("ticket_prefix")
  nextTicketNumber Int      @default(1001) @map("next_ticket_number")
  autoAssign       Boolean  @default(false) @map("auto_assign")
  businessHours    Json?    @map("business_hours") // { timezone, schedule: [{ day, start, end }] }
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("helpdesk_settings")
}
