// =============================================================================
// Booking Module - Prisma Schema
// =============================================================================
// Standalone schema for the schema merger. No datasource/generator blocks.
// Models reference User by foreign key (userId / providerId).

// -----------------------------------------------------------------------------
// Enums
// -----------------------------------------------------------------------------

enum ServiceStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum ReminderType {
  EMAIL
  SMS
  PUSH
}

// -----------------------------------------------------------------------------
// Service Category (many-to-many via link table)
// -----------------------------------------------------------------------------

model ServiceCategory {
  id           String   @id @default(uuid())
  name         String   @unique
  slug         String   @unique
  description  String?
  iconName     String?  @map("icon_name")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  services ServiceCategoryLink[]

  @@map("booking_service_categories")
}

model ServiceCategoryLink {
  serviceId  String @map("service_id")
  categoryId String @map("category_id")

  service  BookingService  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  category ServiceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([serviceId, categoryId])
  @@map("booking_service_category_links")
}

// -----------------------------------------------------------------------------
// Booking Service
// -----------------------------------------------------------------------------

model BookingService {
  id               String        @id @default(uuid())
  name             String
  slug             String        @unique
  description      String
  shortDescription String?       @map("short_description")
  thumbnailUrl     String?       @map("thumbnail_url")
  price            Int           @default(0) // cents, 0 = free
  compareAtPrice   Int?          @map("compare_at_price")
  currency         String        @default("usd")
  duration         Int           @default(60) // minutes
  bufferTime       Int           @default(15) @map("buffer_time") // minutes between bookings
  capacity         Int           @default(1) // max concurrent bookings per slot
  status           ServiceStatus @default(DRAFT)
  isFeatured       Boolean       @default(false) @map("is_featured")
  publishedAt      DateTime?     @map("published_at")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  categories ServiceCategoryLink[]
  providers  ProviderService[]
  bookings   Booking[]
  reviews    BookingReview[]

  @@index([status])
  @@index([slug])
  @@map("booking_services")
}

// -----------------------------------------------------------------------------
// Provider
// -----------------------------------------------------------------------------

model Provider {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  bio         String?
  avatarUrl   String?  @map("avatar_url")
  specialties Json?    // ["Hair Styling", "Coloring"]
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  services   ProviderService[]
  schedules  Schedule[]
  overrides  ScheduleOverride[]
  bookings   Booking[]
  reviews    BookingReview[]

  @@unique([userId])
  @@index([userId])
  @@map("booking_providers")
}

// -----------------------------------------------------------------------------
// Provider-Service (many-to-many)
// -----------------------------------------------------------------------------

model ProviderService {
  providerId String @map("provider_id")
  serviceId  String @map("service_id")

  provider Provider       @relation(fields: [providerId], references: [id], onDelete: Cascade)
  service  BookingService @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@id([providerId, serviceId])
  @@map("booking_provider_services")
}

// -----------------------------------------------------------------------------
// Schedule (weekly recurring)
// -----------------------------------------------------------------------------

model Schedule {
  id         String  @id @default(uuid())
  providerId String  @map("provider_id")
  dayOfWeek  Int     // 0 = Sunday, 6 = Saturday
  startTime  String  @map("start_time") // "HH:mm" format
  endTime    String  @map("end_time")   // "HH:mm" format
  isActive   Boolean @default(true) @map("is_active")

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, dayOfWeek])
  @@index([providerId])
  @@map("booking_schedules")
}

// -----------------------------------------------------------------------------
// Schedule Override (date-specific)
// -----------------------------------------------------------------------------

model ScheduleOverride {
  id         String   @id @default(uuid())
  providerId String   @map("provider_id")
  date       DateTime // specific date
  isBlocked  Boolean  @default(true) @map("is_blocked") // true = vacation/holiday
  startTime  String?  @map("start_time") // custom hours if not blocked
  endTime    String?  @map("end_time")
  reason     String?
  createdAt  DateTime @default(now()) @map("created_at")

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, date])
  @@index([providerId])
  @@map("booking_schedule_overrides")
}

// -----------------------------------------------------------------------------
// Booking
// -----------------------------------------------------------------------------

model Booking {
  id            String        @id @default(uuid())
  bookingNumber String        @unique @map("booking_number") // "BK-" + nanoid
  userId        String        @map("user_id")
  serviceId     String        @map("service_id")
  providerId    String        @map("provider_id")
  date          DateTime      // booking date
  startTime     String        @map("start_time") // "HH:mm"
  endTime       String        @map("end_time")   // "HH:mm"
  status        BookingStatus @default(PENDING)
  totalAmount   Int           @default(0) @map("total_amount") // cents
  currency      String        @default("usd")
  notes         String?
  cancelReason  String?       @map("cancel_reason")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  service   BookingService   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  provider  Provider         @relation(fields: [providerId], references: [id], onDelete: Cascade)
  reminders BookingReminder[]

  @@index([userId])
  @@index([serviceId])
  @@index([providerId])
  @@index([status])
  @@index([date])
  @@map("booking_bookings")
}

// -----------------------------------------------------------------------------
// Booking Reminder
// -----------------------------------------------------------------------------

model BookingReminder {
  id          String       @id @default(uuid())
  bookingId   String       @map("booking_id")
  type        ReminderType @default(EMAIL)
  scheduledAt DateTime     @map("scheduled_at")
  sentAt      DateTime?    @map("sent_at")
  createdAt   DateTime     @default(now()) @map("created_at")

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([scheduledAt])
  @@map("booking_reminders")
}

// -----------------------------------------------------------------------------
// Booking Review
// -----------------------------------------------------------------------------

model BookingReview {
  id         String   @id @default(uuid())
  serviceId  String   @map("service_id")
  providerId String   @map("provider_id")
  userId     String   @map("user_id")
  userName   String?  @map("user_name")
  rating     Int      // 1-5
  comment    String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  service  BookingService @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  provider Provider       @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([serviceId, userId])
  @@index([serviceId])
  @@index([providerId])
  @@index([userId])
  @@map("booking_reviews")
}
